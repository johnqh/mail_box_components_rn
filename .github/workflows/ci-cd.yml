---
# CI/CD workflow for mail_box_components_rn (React Native)
# Automatically publishes to NPM when NPM_TOKEN is configured

name: CI/CD

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

permissions:
  contents: write      # For creating GitHub releases
  id-token: write      # For NPM provenance
  deployments: write   # For deployment tracking

jobs:
  cicd:
    uses: johnqh/workflows/.github/workflows/unified-cicd.yml@main
    with:
      npm-access: "public"
    secrets: inherit  # Pass all repository secrets

  # Publish specialized packages after main package (runs even if main fails)
  publish-specialized:
    needs: cicd
    if: always() && github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        package:
          - analytics
          - devops
          - email
          - marketing
          - social
          - web3

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          registry-url: 'https://registry.npmjs.org'

      - name: Check if package needs publishing
        id: check-version
        run: |
          # Get published version from npm registry (empty if not published)
          PUBLISHED_VERSION=$(npm view @sudobility/${{ matrix.package }}-components-rn version 2>/dev/null || echo "")

          # Get local version from package.json
          LOCAL_VERSION=$(node -p "require('./packages/${{ matrix.package }}-components-rn/package.json').version")

          # Compare versions
          if [ "$PUBLISHED_VERSION" != "$LOCAL_VERSION" ]; then
            echo "changed=1" >> $GITHUB_OUTPUT
            echo "ðŸ“¦ Will publish ${{ matrix.package }}-components-rn@$LOCAL_VERSION (npm: ${PUBLISHED_VERSION:-not published})"
          else
            echo "changed=0" >> $GITHUB_OUTPUT
            echo "âœ“ ${{ matrix.package }}-components-rn@$LOCAL_VERSION already published"
          fi

      - name: Install dependencies
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components-rn
        run: npm install --legacy-peer-deps
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Build package
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components-rn
        run: npm run build

      - name: Publish to NPM
        if: steps.check-version.outputs.changed == '1'
        working-directory: ./packages/${{ matrix.package }}-components-rn
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
